<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Model Architecture Explorer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 0;
      margin: 0;
      background: transparent;
    }

    .container {
      max-width: 100%;
      margin: 0;
      background: transparent;
      padding: 20px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #333;
    }

    .subtitle {
      color: #666;
      margin-bottom: 25px;
      font-size: 14px;
    }

    .subtitle a:hover {
      text-decoration: underline;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #444;
      font-size: 14px;
    }

    select,
    input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d0d0d0;
      border-radius: 4px;
      font-size: 14px;
      background-color: white;
      transition: border-color 0.2s;
    }

    select:focus,
    input:focus {
      outline: none;
      border-color: #2196f3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .loading {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background-color: #e3f2fd;
      border-left: 4px solid #2196f3;
      border-radius: 4px;
      font-size: 14px;
      color: #1976d2;
    }

    .error {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background-color: #ffebee;
      border-left: 4px solid #f44336;
      border-radius: 4px;
      font-size: 14px;
      color: #c62828;
    }

    .results {
      margin-top: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: top;
    }

    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
    }

    tr:hover {
      background-color: #f5f7fa;
    }

    .component-name {
      font-weight: 500;
      color: #333;
    }

    .component-type {
      color: #666;
      font-family: "Courier New", monospace;
    }

    .array-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .array-item {
      padding: 4px 8px;
      background-color: #f5f5f5;
      border-radius: 3px;
      font-family: "Courier New", monospace;
      font-size: 13px;
      color: #666;
    }

    .expandable-row {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .expandable-row:hover {
      background-color: #f0f7ff !important;
    }

    .expandable-indicator {
      display: inline-block;
      margin-right: 8px;
      transition: transform 0.2s;
      color: #2196f3;
      font-weight: bold;
    }

    .expandable-indicator.expanded {
      transform: rotate(90deg);
    }

    .config-detail-row {
      display: none;
      background-color: #f8f9fa;
    }

    .config-detail-row.expanded {
      display: table-row;
    }

    .config-detail-cell {
      padding: 0 !important;
    }

    .config-detail-content {
      padding: 15px 20px;
      border-left: 3px solid #2196f3;
      background-color: white;
      margin: 10px 0;
    }

    .config-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .config-table th {
      background-color: #e3f2fd;
      padding: 8px;
      text-align: left;
      font-weight: 600;
      color: #1976d2;
    }

    .config-table td {
      padding: 8px;
      border-bottom: 1px solid #e0e0e0;
    }

    .note {
      margin-top: 15px;
      padding: 10px;
      background-color: #fff9e6;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      font-size: 13px;
      color: #856404;
    }

    .source-link {
      color: #2196f3;
      text-decoration: none;
      transition: color 0.2s;
      cursor: pointer;
    }

    .source-link:hover {
      color: #1565c0;
      text-decoration: underline;
    }

    /* Responsive design for parameter visualization */
    @media (max-width: 768px) {
      .results>div {
        flex-direction: column !important;
      }

      #parameterChart {
        height: 150px !important;
      }

      #paramSvg {
        height: 150px !important;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîç Model Architecture Explorer</h1>
    <p class="subtitle">
      Explore high-level architecture information from Hugging Face diffusion models
      <br />
      <a href="https://github.com/huggingface/diffusers" target="_blank"
        style="color: #2196f3; text-decoration: none; font-size: 13px; margin-right: 15px">
        üì¶ Diffusers Source Code
      </a>
      <a href="https://github.com/huggingface/transformers" target="_blank"
        style="color: #2196f3; text-decoration: none; font-size: 13px">
        üì¶ Transformers Source Code
      </a>
    </p>

    <div class="input-group">
      <label for="modelSelect">Select a Model:</label>
      <select id="modelSelect">
        <option value="">Loading models...</option>
      </select>
    </div>

    <div class="loading" id="loading">Loading model information...</div>
    <div class="error" id="error"></div>

    <div class="results" id="results" style="display: none">
      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1;">
          <h3 style="margin-bottom: 10px; font-size: 18px; color: #333">Pipeline Components</h3>
          <table id="architectureTable">
            <thead>
              <tr>
                <th>Component</th>
                <th>Model Class</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <div style="flex: 1;">
          <h3 style="margin-bottom: 10px; font-size: 18px; color: #333">Parameter Counts</h3>
          <div id="parameterInfo" style="display: none;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <div style="font-size: 16px; font-weight: 600; color: #1976d2; margin-bottom: 8px;">
                Total Parameters: <span id="totalParams">-</span>
              </div>
              <div style="font-size: 13px; color: #666;">
                Breakdown by component
              </div>
            </div>
            <div id="parameterChart"
              style="height: 200px; background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px;">
              <svg id="paramSvg" width="100%" height="100%" viewBox="0 0 300 170"></svg>
            </div>
          </div>
          <div id="noParameterInfo"
            style="background: #fff9e6; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; color: #856404; font-size: 14px;">
            Parameter count information not available for this model.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const modelSelect = document.getElementById("modelSelect");
    let modelsDatabase = [];
    let sourceMap = {};
    let parameterData = {};

    async function loadSourceMap() {
      try {
        const response = await fetch("source/source_code_map.json");
        sourceMap = await response.json();
      } catch (err) {
        console.warn("Could not load source map:", err);
      }
    }

    async function loadParameterData() {
      try {
        const response = await fetch("model_parameters.json");
        parameterData = await response.json();
      } catch (err) {
        console.warn("Could not load parameter data:", err);
      }
    }

    function createSourceLink(className) {
      if (!className || !sourceMap[className]) {
        return `<span class="component-type">${className}</span>`;
      }

      const info = sourceMap[className];

      // Make it a clickable link to GitHub
      return `<a href="${info.github_url}" target="_blank" class="component-type source-link" onclick="event.stopPropagation();" title="${info.description}">${className}</a>`;
    }

    async function loadModelsDatabase() {
      try {
        const response = await fetch("model_configurations.jsonl");
        const text = await response.text();

        // Parse JSONL (one JSON object per line)
        modelsDatabase = text
          .trim()
          .split("\n")
          .filter((line) => line.trim())
          .map((line) => JSON.parse(line));

        // Populate dropdown
        modelSelect.innerHTML = "";
        modelsDatabase.forEach((model, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = model.model_id;
          modelSelect.appendChild(option);
        });

        // Add change event listener to auto-load on selection
        modelSelect.addEventListener("change", loadModel);

        // Load first model by default
        if (modelsDatabase.length > 0) {
          loadModel();
        }
      } catch (err) {
        showError(`Failed to load models database: ${err.message}`);
      }
    }

    async function loadModel() {
      const loading = document.getElementById("loading");
      const error = document.getElementById("error");
      const results = document.getElementById("results");

      const selectedIndex = parseInt(modelSelect.value);
      if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= modelsDatabase.length) {
        showError("Please select a valid model");
        return;
      }

      const modelData = modelsDatabase[selectedIndex];
      const modelId = modelData.model_id;
      const modelIndex = modelData.model_index;

      if (!modelIndex) {
        showError("Model index not available for this model");
        return;
      }

      // Reset UI
      loading.style.display = "block";
      error.style.display = "none";
      results.style.display = "none";

      try {
        // Build architecture table with expandable configs
        buildArchitectureTable(modelId, modelIndex, modelData);

        // Load and display parameter information
        loadParameterInfo(modelId);

        results.style.display = "block";
        loading.style.display = "none";
      } catch (err) {
        showError(`Error: ${err.message}`);
        loading.style.display = "none";
      }
    }

    function buildArchitectureTable(modelId, modelIndex, modelData) {
      const tableBody = document.getElementById("tableBody");
      tableBody.innerHTML = "";

      const components = [];

      // Extract all components except internal fields
      for (const [key, value] of Object.entries(modelIndex)) {
        if (key.startsWith("_")) continue; // Skip internal fields

        if (Array.isArray(value)) {
          // Handle arrays - extract only the class name, not library names
          const libraryNames = ["diffusers", "transformers", "kandinsky"];
          const className = value.find((item) => !libraryNames.includes(item)) || value[0];

          components.push({
            name: key,
            type: className,
            config: null,
          });
        } else if (typeof value === "string" || value === null) {
          // Simple string value or null
          components.push({
            name: key,
            type: value || "null",
            config: null,
          });
        } else if (typeof value === "object" && value !== null) {
          // It's a component configuration object
          components.push({
            name: key,
            type: JSON.stringify(value),
            config: value,
          });
        }
      }

      // Populate table
      components.forEach((component, index) => {
        const row = tableBody.insertRow();
        const cellName = row.insertCell(0);
        const cellType = row.insertCell(1);

        // Check if this is transformer or unet and has config
        const isMainBlock = component.name === "transformer" || component.name === "unet";
        const hasConfig = isMainBlock && (modelData.transformer_config || modelData.unet_config);

        if (hasConfig) {
          row.classList.add("expandable-row");
          row.onclick = () => toggleConfig(index);
          cellName.innerHTML = `<span class="expandable-indicator" id="indicator-${index}">‚ñ∂</span><span class="component-name">${component.name}</span>`;
        } else {
          cellName.innerHTML = `<span class="component-name">${component.name}</span>`;
        }

        // Display only the component type with source link
        let typeText = component.type;
        cellType.innerHTML = createSourceLink(typeText);

        // Add config detail row if this is transformer or unet
        if (hasConfig) {
          const detailRow = tableBody.insertRow();
          detailRow.classList.add("config-detail-row");
          detailRow.id = `detail-${index}`;

          const detailCell = detailRow.insertCell(0);
          detailCell.colSpan = 2;
          detailCell.classList.add("config-detail-cell");

          // Build configuration table
          const config = component.name === "transformer" ? modelData.transformer_config : modelData.unet_config;
          const configHtml = buildConfigTable(config, component.name);

          detailCell.innerHTML = `<div class="config-detail-content">${configHtml}</div>`;
        }
      });
    }

    function toggleConfig(index) {
      const indicator = document.getElementById(`indicator-${index}`);
      const detailRow = document.getElementById(`detail-${index}`);

      if (detailRow.classList.contains("expanded")) {
        detailRow.classList.remove("expanded");
        indicator.classList.remove("expanded");
      } else {
        detailRow.classList.add("expanded");
        indicator.classList.add("expanded");
      }
    }

    function buildConfigTable(config, blockType) {
      if (!config) return "";

      // Key parameters to display
      const importantParams = [
        "in_channels",
        "out_channels",
        "sample_size",
        "patch_size",
        "num_layers",
        "attention_head_dim",
        "num_attention_heads",
        "cross_attention_heads",
        "cross_attention_head_dim",
        "cross_attention_dim",
        "caption_channels",
        "caption_projection_dim",
        "hidden_size",
        "num_hidden_layers",
        "intermediate_size",
        "model_max_length",
        "attention_bias",
        "activation_function",
        "activation_fn",
        "norm_type",
        "block_out_channels",
        "down_block_types",
        "up_block_types",
        "num_single_layers",
        "joint_attention_dim",
        "pooled_projection_dim",
        "guidance_embeds",
        "mlp_ratio",
        "dropout",
        "norm_eps",
        "norm_elementwise_affine",
        "norm_num_groups",
        "interpolation_scale",
        "pos_embed_max_size",
        "rope_axes_dim",
        "axes_dims_rope",
        "axes_dim_rope",
        "axes_lens",
        "qk_norm",
        "num_kv_heads",
        "num_routed_experts",
        "num_activated_experts",
        "ffn_dim_multiplier",
        "multiple_of",
        "scaling_factor",
        "condition_dim",
        "text_embed_dim",
        "time_embed_dim",
        "text_emb_dim",
        "cap_feat_dim",
        "max_resolution",
        "llama_layers",
        "num_refiner_layers",
      ];

      let tableHtml = `
                <strong style="color: #1976D2; font-size: 14px; display: block; margin-bottom: 10px;">
                    ${blockType.charAt(0).toUpperCase() + blockType.slice(1)} Configuration
                </strong>
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>`;

      for (const [key, value] of Object.entries(config)) {
        if (key.startsWith("_")) continue;
        if (key.endsWith("_class_name") || key === "architectures") continue;

        if (importantParams.includes(key)) {
          let displayValue;

          if (Array.isArray(value)) {
            const arrayItems = value
              .map((item) => {
                let itemStr = typeof item === "string" ? item : JSON.stringify(item);
                if (itemStr.length > 80) {
                  itemStr = itemStr.substring(0, 80) + "...";
                }
                return `<div class="array-item">${itemStr}</div>`;
              })
              .join("");
            displayValue = `<div class="array-container">${arrayItems}</div>`;
          } else if (typeof value === "object" && value !== null) {
            displayValue = JSON.stringify(value);
            if (displayValue.length > 100) {
              displayValue = displayValue.substring(0, 100) + "...";
            }
            displayValue = `<span class="component-type">${displayValue}</span>`;
          } else {
            displayValue = `<span class="component-type">${String(value)}</span>`;
          }

          tableHtml += `
                        <tr>
                            <td><span class="component-name">${key}</span></td>
                            <td>${displayValue}</td>
                        </tr>`;
        }
      }

      tableHtml += `</tbody></table>`;
      return tableHtml;
    }

    function loadParameterInfo(modelId) {
      const parameterInfo = document.getElementById("parameterInfo");
      const noParameterInfo = document.getElementById("noParameterInfo");

      if (parameterData[modelId]) {
        const data = parameterData[modelId];

        // Update total parameters display
        document.getElementById("totalParams").textContent = `${data.total_params}B`;

        // Create parameter chart
        createParameterChart(data);

        parameterInfo.style.display = "block";
        noParameterInfo.style.display = "none";
      } else {
        parameterInfo.style.display = "none";
        noParameterInfo.style.display = "block";
      }
    }

    function createParameterChart(data) {
      const svg = document.getElementById("paramSvg");
      svg.innerHTML = "";

      const width = 300;
      const height = 170;
      const margin = { top: 20, right: 20, bottom: 40, left: 80 };
      const chartWidth = width - margin.left - margin.right;
      const chartHeight = height - margin.top - margin.bottom;

      // Color scheme for different component types
      const colors = {
        'text_encoder': '#3b82f6',
        'text_encoder_2': '#1d4ed8',
        'text_encoder_3': '#1e40af',
        'transformer': '#10b981',
        'unet': '#f59e0b',
        'decoder': '#f59e0b',
        'vae': '#8b5cf6',
        'vqgan': '#8b5cf6',
        'image_encoder': '#ef4444',
        // 'tokenizer': '#6366f1',
        // 'tokenizer_2': '#4f46e5',
        // 'scheduler': '#ec4899',
        // 'safety_checker': '#f97316',
        // 'feature_extractor': '#14b8a6',
        // 'clip_image_processor': '#14b8a6',
        // 'clip_tokenizer': '#6366f1',
        'text_decoder': '#06b6d4',
        'movq': '#8b5cf6'
      };

      // Prepare data for visualization
      const components = Object.entries(data.components).map(([name, value]) => ({
        name: name,
        value: value,
        percentage: (value / data.total_params) * 100
      }));

      // Sort by value descending
      components.sort((a, b) => b.value - a.value);

      // Create horizontal bar chart
      const maxValue = Math.max(...components.map(c => c.value));
      const scale = chartWidth / maxValue;

      components.forEach((component, index) => {
        const barHeight = chartHeight / components.length * 0.8;
        const y = margin.top + index * (chartHeight / components.length) + (chartHeight / components.length - barHeight) / 2;
        const barWidth = component.value * scale;
        const color = colors[component.name] || '#6b7280';

        // Component name label
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', margin.left - 10);
        label.setAttribute('y', y + barHeight / 2 + 4);
        label.setAttribute('text-anchor', 'end');
        label.setAttribute('font-size', '11');
        label.setAttribute('fill', '#374151');
        label.textContent = component.name.replace('_', ' ');
        svg.appendChild(label);

        // Bar
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', margin.left);
        rect.setAttribute('y', y);
        rect.setAttribute('width', barWidth);
        rect.setAttribute('height', barHeight);
        rect.setAttribute('fill', color);
        rect.setAttribute('rx', 2);
        svg.appendChild(rect);

        // Value label
        const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        valueLabel.setAttribute('x', margin.left + barWidth + 5);
        valueLabel.setAttribute('y', y + barHeight / 2 + 4);
        valueLabel.setAttribute('font-size', '11');
        valueLabel.setAttribute('fill', '#374151');
        valueLabel.textContent = `${component.value.toFixed(2)}B`;
        svg.appendChild(valueLabel);
      });

      // Add axis labels
      const xAxisLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      xAxisLabel.setAttribute('x', width / 2);
      xAxisLabel.setAttribute('y', height - 5);
      xAxisLabel.setAttribute('text-anchor', 'middle');
      xAxisLabel.setAttribute('font-size', '12');
      xAxisLabel.setAttribute('fill', '#6b7280');
      xAxisLabel.textContent = 'Parameters (Billions)';
      svg.appendChild(xAxisLabel);
    }

    function showError(message) {
      const error = document.getElementById("error");
      error.textContent = message;
      error.style.display = "block";
    }

    // Function to send height to parent window
    function sendHeightToParent() {
      const height = document.body.scrollHeight;
      window.parent.postMessage(
        {
          type: "resize",
          source: "architecture-explorer",
          height: height,
        },
        "*"
      );
    }

    // Send height on load and whenever content changes
    window.addEventListener("load", async function () {
      await loadSourceMap();
      await loadParameterData();
      loadModelsDatabase();

      // Initial height update
      setTimeout(sendHeightToParent, 100);
    });

    // Observe DOM changes to update height
    const observer = new MutationObserver(function () {
      sendHeightToParent();
    });

    // Start observing when DOM is ready
    if (document.body) {
      observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
      });
    }
  </script>
</body>

</html>