<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive BoR Explorer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }
        input[type=range] {
            width: 100%;
        }
        .value {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2>Interactive BoR Explorer</h2>

    <p>
        This widget uses the exact hypergeometric formula for <b>P_rand</b>, the Poisson approximation,
        and computes <b>λ</b>, <b>BoR_max</b>, and <b>R_q / N</b>.
        Adjust the sliders to explore when BoR collapses.
    </p>

    <div style="border:1px solid #ddd; padding:20px; border-radius:10px;">

        <label>Corpus Size N: <span id="N_val" class="value">1000</span></label>
        <input type="range" id="N" min="10" max="500" value="58">

        <label>Relevant per query R̄<sub>q</sub>: <span id="R_val" class="value">10</span></label>
        <input type="range" id="R" min="1" max="500" value="4">

        <label>Retrieval Depth K: <span id="K_val" class="value">5</span></label>
        <input type="range" id="K" min="1" max="500" value="58">

        <hr>

        <p><b>λ = K · R_q / N:</b> <span id="lambda">–</span></p>
        <p><b>P_rand (exact):</b> <span id="p_exact">–</span></p>
        <p><b>P_rand (Poisson approx):</b> <span id="p_poisson">–</span></p>
        <p><b>BoR_max (bits):</b> <span id="bor">–</span></p>
        <p><b>R_q / N (%):</b> <span id="ratio">–</span></p>

        <p id="status" style="font-weight:bold;"></p>

    </div>

    <script>
        function comb(n, r) {
            if (r > n || r < 0) return 0;
            r = Math.min(r, n - r);
            let num = 1, den = 1;
            for (let i = 1; i <= r; i++) {
                num *= (n - (r - i));
                den *= i;
            }
            return num / den;
        }

        function calculate_lambda(K, R_q, N) {
            return (K * R_q) / N;
        }

        function calculate_p_rand_exact(K, R_q, N) {
            const irrelevant = N - R_q;
            if (K > irrelevant) return 1.0;
            const p_all_irrelevant = comb(irrelevant, K) / comb(N, K);
            return 1 - p_all_irrelevant;
        }

        function calculate_p_rand_poisson(K, R_q, N) {
            const lambda = calculate_lambda(K, R_q, N);
            return 1 - Math.exp(-lambda);
        }

        function calculate_bor_max(p_rand) {
            if (p_rand >= 1) return 0;
            if (p_rand <= 0) return Infinity;
            return -Math.log2(p_rand);
        }

        function calculate_ratio(R_q, N) {
            return (R_q / N) * 100;
        }

        function compute() {
            const N = Number(document.getElementById("N").value);
            const R = Number(document.getElementById("R").value);
            const K = Number(document.getElementById("K").value);

            document.getElementById("N_val").textContent = N;
            document.getElementById("R_val").textContent = R;
            document.getElementById("K_val").textContent = K;

            const lambda = calculate_lambda(K, R, N);
            const p_exact = calculate_p_rand_exact(K, R, N);
            const p_poisson = calculate_p_rand_poisson(K, R, N);
            const bor = calculate_bor_max(p_exact);
            const ratio = calculate_ratio(R, N);

            document.getElementById("lambda").textContent = lambda.toFixed(6);
            document.getElementById("p_exact").textContent = p_exact.toFixed(6);
            document.getElementById("p_poisson").textContent = p_poisson.toFixed(6);
            document.getElementById("bor").textContent = bor.toFixed(6);
            document.getElementById("ratio").textContent = ratio.toFixed(3) + "%";

            const status = document.getElementById("status");
            if (lambda >= 3) {
                status.textContent = "⚠ COLLAPSE ZONE: Random chance overwhelms retrieval.";
                status.style.color = "red";
            } else {
                status.textContent = "✔ Safe zone: Retrieval quality remains measurable.";
                status.style.color = "green";
            }
        }

        ["N", "R", "K"].forEach(id =>
            document.getElementById(id).addEventListener("input", compute)
        );

        compute();
    </script>
</body>
</html>
